# =============================================================================
# PRE-COMMIT CONFIGURATION (2025-02)
# =============================================================================
# Hardened quality gates for Python development with comprehensive security,
# linting, type-checking, and test automation. Uses uv for fast Python testing.
# =============================================================================

minimum_pre_commit_version: "3.7.0"
default_language_version:
  # Use system/active venv python; rag-service venv is activated in dev shells
  python: python3
default_install_hook_types:
  - pre-commit
  - pre-push
  - commit-msg
  - prepare-commit-msg
default_stages:
  - pre-commit
fail_fast: false
ci:
  autofix_prs: false
  autoupdate_schedule: monthly
  skip: []
exclude: |
  (?x)^(
    \.git/|
    \.venv/|
    \.pytest_cache/|
    __pycache__/|
    \.mypy_cache/|
    \.ruff_cache/|
    \.coverage|
    htmlcov/|
    \.next/|
    node_modules/|
    dist/|
    build/|
    \.egg-info/|
    \.tox/|
    \.nox/|
    \.hypothesis/|
    \.benchmarks/|
    \.gitattributes|
    \.gitignore|
    \.dockerignore|
    \.env.*|
    \.secrets|
    \.sops.*|
    \.gitleaks\.toml|
    \.gitmessage|
    CHANGELOG\.md|
    LICENSE.*|
    \.cursor/|
    \.vscode/|
    \.idea/|
    \.DS_Store|
    mlruns/|
    artifacts/|
    volumes/
  )

repos:
  # =============================================================================
  # SECURITY & SECRETS
  # =============================================================================
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.30.0
    hooks:
      - id: gitleaks
        name: gitleaks (secrets scan)
        stages: [pre-commit, pre-push]
        args:
          - "--config"
          - ".gitleaks.toml"
          - "--no-banner"
          - "--redact"

  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        args:
          - "--baseline"
          - ".secrets.baseline"
        exclude: \.lock$

  # NOTE: SOPS hook disabled - enable when secrets/ directory or .env.prod|staging files exist
  # - repo: https://github.com/yuvipanda/pre-commit-hook-ensure-sops
  #   rev: v1.1
  #   hooks:
  #     - id: sops-encryption
  #       files: secrets/.*\.(yaml|yml|json|env)$|\.env\.(prod|production|staging)$

  - repo: https://github.com/returntocorp/semgrep
    rev: v1.148.0
    hooks:
      - id: semgrep
        name: semgrep (policy)
        stages: [pre-push]
        args:
          - "--config"
          - "p/ci"
          - "--error"
          - "--timeout"
          - "120"

  - repo: https://github.com/PyCQA/bandit
    rev: 1.9.2
    hooks:
      - id: bandit
        args:
          - "-c"
          - "pyproject.toml"
          - "-q"

  # NOTE: pip-audit disabled - uses ensurepip internally which conflicts with uv-managed
  # Python environments (causes SIGABRT). Consider running `uv pip audit` manually or in CI.
  # - repo: https://github.com/pypa/pip-audit
  #   rev: v2.9.0
  #   hooks:
  #     - id: pip-audit
  #       stages: [pre-push]
  #       args:
  #         - "--progress-spinner=off"
  #         - "--desc"
  #         - "on"
  #         - "."

  # NOTE: safety hook disabled - requires Poetry ([tool.poetry] in pyproject.toml).
  # This project uses setuptools. Consider running safety check in CI workflow instead.
  # - repo: https://github.com/Lucas-C/pre-commit-hooks-safety
  #   rev: v1.4.2
  #   hooks:
  #     - id: python-safety-dependencies-check
  #       name: safety (python deps)
  #       stages: [pre-push]
  #       args:
  #         - "--disable-optional-telemetry-data"

  # NOTE: trufflehog hook disabled - has executable permission bug (trufflehog.sh is 644).
  # Secret scanning is already covered by gitleaks above.
  # - repo: https://github.com/the-cashman/pre-commit-trufflehog
  #   rev: 0849fdcf97d03e3ee90be8e8b187774ff4f062ab  # pragma: allowlist secret
  #   hooks:
  #     - id: trufflehog
  #       name: trufflehog (entropy scan)
  #       stages: [pre-push]
  #       pass_filenames: false

  # =============================================================================
  # GENERAL HYGIENE
  # =============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
        args: ["--unsafe"]
      - id: check-json
      - id: check-toml
      - id: check-merge-conflict
      - id: check-case-conflict
      - id: check-added-large-files
        args: ["--maxkb=2048"]
      - id: check-shebang-scripts-are-executable
      - id: check-executables-have-shebangs
      - id: mixed-line-ending
        args: ["--fix=lf"]
      - id: debug-statements
      - id: check-ast
      - id: check-builtin-literals
      - id: forbid-new-submodules

  - repo: https://github.com/jumanjihouse/pre-commit-hooks
    rev: 3.0.0
    hooks:
      - id: shellcheck
      - id: shfmt
        args: ["-i", "2", "-ci"]

  # =============================================================================
  # PYTHON QUALITY
  # =============================================================================
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.13
    hooks:
      - id: ruff
        args: ["--fix", "--exit-non-zero-on-fix", "--config=pyproject.toml"]
      - id: ruff-format
        args: ["--config=pyproject.toml"]

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.19.1
    hooks:
      - id: mypy
        args: ["--config-file=pyproject.toml"]
        files: ^src/rlm/
        exclude: ^(tests/|build/|references/)
        additional_dependencies:
          - pydantic>=2.10.5
          - pydantic-settings>=2.7.1
          - types-requests>=2.32.0.20241016
          - types-setuptools>=75.8.0.20250110
          - types-PyYAML>=6.0.12.20241230
          - types-toml>=0.10.8.20240310
          - numpy>=2.2.2
          - loguru>=0.7.0

  - repo: https://github.com/DetachHead/basedpyright-pre-commit-mirror
    rev: 1.37.1
    hooks:
      - id: basedpyright
        stages: [pre-commit]
        files: ^src/rlm/
        exclude: ^(tests/|build/|references/)
        args:
          - "--pythonversion"
          - "3.12"
        additional_dependencies: []

  # =============================================================================
  # PYTHON TEST MATRICES (uv-run)
  # =============================================================================
  - repo: https://github.com/andrewaylett/pre-commit-hooks
    rev: v0.7.1
    hooks:
      # Fast feedback: unit tests on every commit (parallel via pytest-xdist)
      - id: uv-run
        name: python unit tests (uv)
        stages: [pre-commit]
        args: ["pytest", "tests/unit", "-n", "auto", "-q", "--maxfail=1", "--disable-warnings"]

      # Pre-push: integration, e2e, and performance tests before code reaches remote
      - id: uv-run
        name: python integration tests (uv)
        stages: [pre-push]
        args: ["pytest", "tests/integration", "-n", "auto", "-q", "--maxfail=1", "--disable-warnings"]

      - id: uv-run
        name: python e2e tests (uv)
        stages: [pre-push]
        args: ["pytest", "tests/e2e", "-n", "auto", "-q", "--maxfail=1", "--disable-warnings"]

  - repo: local
    hooks:
      # NOTE: Benchmarks run serially (no -n auto) to avoid timing skew from CPU contention
      - id: pytest-performance-benchmarks
        name: python performance benchmarks (uv)
        stages: [pre-push]
        entry: bash -c 'mkdir -p .benchmarks && uv run --group test pytest tests/performance tests/benchmark -q --maxfail=1 --disable-warnings --benchmark-json=.benchmarks/pre-push.json'
        language: system
        pass_filenames: false


  # =============================================================================
  # CONTAINERS
  # =============================================================================
  - repo: https://github.com/hadolint/hadolint
    rev: v2.14.0
    hooks:
      - id: hadolint-docker
        args: ["--ignore", "DL3008", "--ignore", "DL3013", "--ignore", "DL3009"]

  - repo: https://github.com/pryorda/dockerfilelint-precommit-hooks
    rev: v0.1.0  # pragma: allowlist secret
    hooks:
      - id: dockerfilelint
        files: Dockerfile.*$

  # =============================================================================
  # YAML / JSON / GITOPS
  # =============================================================================
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.38.0
    hooks:
      - id: yamllint
        args: ["-c", ".yamllint.yaml"]
        exclude: ^(charts/|templates/|\.github/workflows/)

  - repo: https://github.com/python-jsonschema/check-jsonschema
    rev: 0.36.0
    hooks:
      - id: check-github-workflows
      - id: check-github-actions
      - id: check-dependabot

  - repo: https://github.com/rhysd/actionlint
    rev: v1.7.10
    hooks:
      - id: actionlint
        stages: [pre-commit]

  # =============================================================================
  # COMMITS & DOCS
  # =============================================================================
  - repo: https://github.com/commitizen-tools/commitizen
    rev: v4.11.6
    hooks:
      - id: commitizen
        stages: [commit-msg]

      - id: commitizen-branch
        stages: [pre-push]

  - repo: https://github.com/jorisroovers/gitlint
    rev: v0.19.1
    hooks:
      - id: gitlint
        stages: [commit-msg]

  - repo: https://github.com/spinergie/pre-commit-dprint
    rev: v0.50.1
    hooks:
      - id: dprint
        name: dprint (markdown formatter)
        types: [markdown]
        exclude: ^(CHANGELOG\.md|LICENSE\.md|docs/.*|\.cursor/.*|AGENTS\.md|README\.md|tests/.*/README\.md)$

  - repo: https://github.com/DavidAnson/markdownlint-cli2
    rev: v0.20.0  # pragma: allowlist secret
    hooks:
      - id: markdownlint-cli2
        args: ["--config", ".markdownlint.yaml"]
        exclude: ^(CHANGELOG\.md|LICENSE\.md|docs/.*|\.cursor/.*|AGENTS\.md|README\.md|tests/.*/README\.md)$
