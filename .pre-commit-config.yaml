# =============================================================================
# RESEARCH-GRADE PRE-COMMIT CONFIGURATION (2025-02)
# =============================================================================
# Hardened quality gates covering Python, Rust, C++, and Bash code paths.
# Uses published hook repositories + local hooks for GTest and bats testing.
# Native language testing: pytest (Python), cargo (Rust), GTest (C++), bats (Bash)
# =============================================================================

minimum_pre_commit_version: "3.7.0"
default_language_version:
  # Use system/active venv python; rag-service venv is activated in dev shells
  python: python3
default_install_hook_types:
  - pre-commit
  - pre-push
  - commit-msg
  - prepare-commit-msg
default_stages:
  - pre-commit
fail_fast: false
ci:
  autofix_prs: false
  autoupdate_schedule: monthly
  skip: []
exclude: |
  (?x)^(
    \.git/|
    \.venv/|
    \.pytest_cache/|
    __pycache__/|
    \.mypy_cache/|
    \.ruff_cache/|
    \.coverage|
    htmlcov/|
    \.next/|
    node_modules/|
    dist/|
    build/|
    \.egg-info/|
    \.tox/|
    \.nox/|
    \.hypothesis/|
    \.benchmarks/|
    \.gitattributes|
    \.gitignore|
    \.dockerignore|
    \.env.*|
    \.secrets|
    \.sops.*|
    \.gitleaks\.toml|
    \.gitmessage|
    CHANGELOG\.md|
    LICENSE.*|
    \.cursor/|
    \.vscode/|
    \.idea/|
    \.DS_Store|
    mlruns/|
    artifacts/|
    volumes/
  )

repos:
  # =============================================================================
  # SECURITY & SECRETS
  # =============================================================================
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.24.0
    hooks:
      - id: gitleaks
        name: gitleaks (secrets scan)
        stages: [pre-commit, pre-push]
        args:
          - "--config"
          - ".gitleaks.toml"
          - "--no-banner"
          - "--redact"

  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        args:
          - "--baseline"
          - ".secrets.baseline"
        exclude: \.lock$

  - repo: https://github.com/yuvipanda/pre-commit-hook-ensure-sops
    rev: v1.1
    hooks:
      - id: sops-encryption
        # Ensures files matching patterns are encrypted with SOPS
        # Works with .sops.yaml configuration
        files: secrets/.*\.(yaml|yml|json|env)$|\.env\.(prod|production|staging)$

  - repo: https://github.com/returntocorp/semgrep
    rev: v1.139.0
    hooks:
      - id: semgrep
        name: semgrep (policy)
        stages: [pre-push]
        args:
          - "--config"
          - "p/ci"
          - "--error"
          - "--timeout"
          - "120"

  - repo: https://github.com/PyCQA/bandit
    rev: 1.8.6
    hooks:
      - id: bandit
        args:
          - "-c"
          - "pyproject.toml"
          - "-q"

  - repo: https://github.com/pypa/pip-audit
    rev: v2.9.0
    hooks:
      - id: pip-audit
        stages: [pre-push]
        args:
          - "--progress-spinner=off"
          - "--desc"
          - "on"
          # - "-P"
          - "."

  - repo: https://github.com/Lucas-C/pre-commit-hooks-safety
    rev: v1.4.2
    hooks:
      - id: python-safety-dependencies-check
        name: safety (python deps)
        stages: [pre-push]
        args:
          - "--disable-optional-telemetry-data"

  - repo: https://github.com/the-cashman/pre-commit-trufflehog
    rev: 0849fdcf97d03e3ee90be8e8b187774ff4f062ab  # pragma: allowlist secret
    hooks:
      - id: trufflehog
        name: trufflehog (entropy scan)
        stages: [pre-push]
        pass_filenames: false

  # =============================================================================
  # GENERAL HYGIENE
  # =============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
        args: ["--unsafe"]
      - id: check-json
      - id: check-toml
      - id: check-merge-conflict
      - id: check-case-conflict
      - id: check-added-large-files
        args: ["--maxkb=2048"]
      - id: check-shebang-scripts-are-executable
      - id: check-executables-have-shebangs
      - id: mixed-line-ending
        args: ["--fix=lf"]
      - id: debug-statements
      - id: check-ast
      - id: check-builtin-literals
      - id: forbid-new-submodules

  - repo: https://github.com/jumanjihouse/pre-commit-hooks
    rev: 3.0.0
    hooks:
      - id: shellcheck
      - id: shfmt
        args: ["-i", "2", "-ci"]

  # =============================================================================
  # BASH/SHELL TESTING (bats)
  # =============================================================================
  - repo: local
    hooks:
      - id: bats-unit
        name: bats unit tests
        entry: >-
          bash -c 'if [ -d tests/unit/bats ]; then bats tests/unit/bats; else echo "Skipping tests/unit/bats not found"; fi'
        language: system
        stages: [pre-commit]
        files: \.sh$
        pass_filenames: false

      - id: bats-integration
        name: bats integration tests
        entry: >-
          bash -c 'if [ -d tests/integration/bats ]; then bats tests/integration/bats; else echo "Skipping tests/integration/bats not found"; fi'
        language: system
        stages: [pre-push]
        files: \.sh$
        pass_filenames: false

      - id: bats-e2e
        name: bats e2e tests
        entry: >-
          bash -c 'if [ -d tests/e2e/bats ]; then bats tests/e2e/bats; else echo "Skipping tests/e2e/bats not found"; fi'
        language: system
        stages: [pre-push]
        files: \.sh$
        pass_filenames: false

      - id: bats-security
        name: bats security tests
        entry: >-
          bash -c 'if [ -d tests/security/bats ]; then bats tests/security/bats; else echo "Skipping tests/security/bats not found"; fi'
        language: system
        stages: [pre-push]
        files: \.sh$
        pass_filenames: false

      - id: bats-performance
        name: bats performance tests
        entry: >-
          bash -c 'if [ -d tests/performance/bats ]; then bats tests/performance/bats; else echo "Skipping tests/performance/bats not found"; fi'
        language: system
        stages: [pre-push]
        files: \.sh$
        pass_filenames: false

      - id: bats-chaos
        name: bats chaos tests
        entry: >-
          bash -c 'if [ -d tests/chaos/bats ]; then bats tests/chaos/bats; else echo "Skipping tests/chaos/bats not found"; fi'
        language: system
        stages: [pre-push]
        files: \.sh$
        pass_filenames: false

  # =============================================================================
  # PYTHON QUALITY
  # =============================================================================
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.9.3
    hooks:
      - id: ruff
        args: ["--fix", "--exit-non-zero-on-fix", "--config=pyproject.toml"]
      - id: ruff-format
        args: ["--config=pyproject.toml"]

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.14.1
    hooks:
      - id: mypy
        args: ["--config-file=pyproject.toml"]
        files: ^src/rlm/
        exclude: ^(tests/|build/|references/)
        additional_dependencies:
          - pydantic>=2.10.5
          - pydantic-settings>=2.7.1
          - types-requests>=2.32.0.20241016
          - types-setuptools>=75.8.0.20250110
          - types-PyYAML>=6.0.12.20241230
          - types-toml>=0.10.8.20240310
          - numpy>=2.2.2
          - loguru>=0.7.0

  - repo: https://github.com/RobertCraigie/pyright-python
    rev: v1.1.406
    hooks:
      - id: pyright
        stages: [pre-commit]
        files: ^src/rlm/
        exclude: ^(tests/|build/|references/)
        args:
          - "--pythonversion"
          - "3.12"
        additional_dependencies: []

  # =============================================================================
  # PYTHON TEST MATRICES (uv-run)
  # =============================================================================
  - repo: https://github.com/andrewaylett/pre-commit-hooks
    rev: v0.7.0
    hooks:
      - id: uv-run
        name: python unit tests (uv)
        stages: [pre-commit]
        args:
          [
            "pytest",
            "tests/unit",
            "-q",
            "--maxfail=1",
            "--disable-warnings",
            "--ignore-glob=tests/unit/bats/*",
            "--ignore-glob=tests/unit/rust/*",
            "--ignore-glob=tests/unit/cpp/*",
          ]

      - id: uv-run
        name: python integration tests (uv)
        stages: [pre-push]
        args:
          [
            "pytest",
            "tests/integration",
            "-q",
            "--maxfail=1",
            "--disable-warnings",
            "--ignore-glob=tests/integration/bats/*",
            "--ignore-glob=tests/integration/rust/*",
            "--ignore-glob=tests/integration/cpp/*",
          ]

      - id: uv-run
        name: python e2e tests (uv)
        stages: [pre-push]
        args:
          [
            "pytest",
            "tests/e2e",
            "-q",
            "--maxfail=1",
            "--disable-warnings",
            "--ignore-glob=tests/e2e/bats/*",
            "--ignore-glob=tests/e2e/rust/*",
            "--ignore-glob=tests/e2e/cpp/*",
          ]

      - id: uv-run
        name: python security tests (uv)
        stages: [pre-push]
        args:
          [
            "pytest",
            "tests/security",
            "-q",
            "--maxfail=1",
            "--disable-warnings",
            "--ignore-glob=tests/security/bats/*",
            "--ignore-glob=tests/security/rust/*",
            "--ignore-glob=tests/security/cpp/*",
          ]

      - id: uv-run
        name: python performance tests (uv)
        stages: [pre-push]
        args:
          [
            "pytest",
            "tests/performance",
            "-q",
            "--maxfail=1",
            "--disable-warnings",
            "--ignore-glob=tests/performance/bats/*",
            "--ignore-glob=tests/performance/rust/*",
            "--ignore-glob=tests/performance/cpp/*",
          ]

      - id: uv-run
        name: python chaos tests (uv)
        stages: [pre-push]
        args:
          [
            "pytest",
            "tests/chaos",
            "-q",
            "--maxfail=1",
            "--disable-warnings",
            "--ignore-glob=tests/chaos/bats/*",
            "--ignore-glob=tests/chaos/rust/*",
            "--ignore-glob=tests/chaos/cpp/*",
          ]

  # =============================================================================
  # RUST QUALITY & TESTING
  # =============================================================================
  - repo: https://github.com/AndrejOrsula/pre-commit-cargo
    rev: 0.4.0
    hooks:
      - id: cargo-fmt
        stages: [pre-commit]
        args: ["--all"]

      - id: cargo-check
        stages: [pre-commit]
        args: ["--workspace"]

      - id: cargo-clippy
        stages: [pre-commit]
        args: ["--workspace", "--", "-D", "warnings"]

      - id: cargo-test
        name: cargo test (unit)
        stages: [pre-commit]
        args:
          [
            "--manifest-path",
            "tests/unit/rust/Cargo.toml",
            "--",
            "--test-threads=1",
          ]

      - id: cargo-test
        name: cargo test (integration)
        stages: [pre-push]
        args:
          [
            "--manifest-path",
            "tests/integration/rust/Cargo.toml",
            "--",
            "--test-threads=1",
          ]

      - id: cargo-test
        name: cargo test (e2e)
        stages: [pre-push]
        args:
          [
            "--manifest-path",
            "tests/e2e/rust/Cargo.toml",
            "--",
            "--test-threads=1",
            "--nocapture",
          ]

      - id: cargo-test
        name: cargo test (security)
        stages: [pre-push]
        args:
          [
            "--manifest-path",
            "tests/security/rust/Cargo.toml",
            "--",
            "--test-threads=1",
            "--nocapture",
          ]

      - id: cargo-test
        name: cargo test (performance)
        stages: [pre-push]
        args:
          [
            "--manifest-path",
            "tests/performance/rust/Cargo.toml",
            "--",
            "--test-threads=1",
            "--nocapture",
          ]

      - id: cargo-test
        name: cargo test (chaos)
        stages: [pre-push]
        args:
          [
            "--manifest-path",
            "tests/chaos/rust/Cargo.toml",
            "--",
            "--test-threads=1",
            "--nocapture",
          ]

      - id: cargo-test-doc
        stages: [pre-push]
        args: ["--workspace"]

      - id: cargo-deny-check
        name: cargo deny (advisories)
        stages: [pre-push]

  - repo: https://github.com/aRustyDev/pre-commit-hooks
    rev: v0.3.0
    hooks:
      - id: cargo-bench
        stages: [pre-push]

  # =============================================================================
  # C/C++ QUALITY & TESTING
  # =============================================================================
  - repo: https://github.com/pocc/pre-commit-hooks
    rev: 336fdd7c3cab698ead0b1c95157b9e74d3906b62  # pragma: allowlist secret
    hooks:
      - id: clang-format
        stages: [pre-commit]

      - id: clang-tidy
        stages: [pre-push]

      - id: cppcheck
        stages: [pre-push]

  # C++ Test Matrices (GTest)
  - repo: local
    hooks:
      - id: gtest-unit
        name: gtest unit tests
        entry: >-
          bash -c 'if [ -d tests/unit/cpp ]; then cd tests/unit/cpp && cmake -B build -S . && cmake --build build && ./build/unit_tests; else echo "Skipping tests/unit/cpp not found"; fi'
        language: system
        stages: [pre-commit]
        files: \.(cpp|hpp|h|cc|cxx)$
        pass_filenames: false

      - id: gtest-integration
        name: gtest integration tests
        entry: >-
          bash -c 'if [ -d tests/integration/cpp ]; then cd tests/integration/cpp && cmake -B build -S . && cmake --build build && ./build/integration_tests; else echo "Skipping tests/integration/cpp not found"; fi'
        language: system
        stages: [pre-push]
        files: \.(cpp|hpp|h|cc|cxx)$
        pass_filenames: false

      - id: gtest-e2e
        name: gtest e2e tests
        entry: >-
          bash -c 'if [ -d tests/e2e/cpp ]; then cd tests/e2e/cpp && cmake -B build -S . && cmake --build build && ./build/e2e_tests; else echo "Skipping tests/e2e/cpp not found"; fi'
        language: system
        stages: [pre-push]
        files: \.(cpp|hpp|h|cc|cxx)$
        pass_filenames: false

      - id: gtest-security
        name: gtest security tests
        entry: >-
          bash -c 'if [ -d tests/security/cpp ]; then cd tests/security/cpp && cmake -B build -S . && cmake --build build && ./build/security_tests; else echo "Skipping tests/security/cpp not found"; fi'
        language: system
        stages: [pre-push]
        files: \.(cpp|hpp|h|cc|cxx)$
        pass_filenames: false

      - id: gtest-performance
        name: gtest performance tests
        entry: >-
          bash -c 'if [ -d tests/performance/cpp ]; then cd tests/performance/cpp && cmake -B build -S . && cmake --build build && ./build/performance_tests; else echo "Skipping tests/performance/cpp not found"; fi'
        language: system
        stages: [pre-push]
        files: \.(cpp|hpp|h|cc|cxx)$
        pass_filenames: false

      - id: gtest-chaos
        name: gtest chaos tests
        entry: >-
          bash -c 'if [ -d tests/chaos/cpp ]; then cd tests/chaos/cpp && cmake -B build -S . && cmake --build build && ./build/chaos_tests; else echo "Skipping tests/chaos/cpp not found"; fi'
        language: system
        stages: [pre-push]
        files: \.(cpp|hpp|h|cc|cxx)$
        pass_filenames: false

  # =============================================================================
  # JAVASCRIPT / TYPESCRIPT
  # =============================================================================
  # - repo: https://github.com/pre-commit/mirrors-prettier
  #   rev: v4.0.0-alpha.8
  #   hooks:
  #     - id: prettier
  #       types_or: [javascript, jsx, ts, tsx, json, yaml, markdown]
  #       additional_dependencies:
  #         - prettier@3.4.2
  #         - "@trivago/prettier-plugin-sort-imports@5.2.2"
  #         - prettier-plugin-tailwindcss@0.6.11
  #       args: ["--write", "--list-different"]

  # - repo: https://github.com/pre-commit/mirrors-eslint
  #   rev: v9.37.0
  #   hooks:
  #     - id: eslint
  #       additional_dependencies:
  #         - eslint@9.37.0
  #         - "@typescript-eslint/eslint-plugin@8.20.0"
  #         - "@typescript-eslint/parser@8.20.0"
  #         - eslint-config-prettier@9.1.0
  #         - eslint-plugin-import@2.31.0
  #         - eslint-plugin-security@3.0.1
  #       files: \.[jt]sx?$
  #       types: [file]

  # =============================================================================
  # CONTAINERS
  # =============================================================================
  - repo: https://github.com/hadolint/hadolint
    rev: v2.13.1
    hooks:
      - id: hadolint-docker
        args: ["--ignore", "DL3008", "--ignore", "DL3013", "--ignore", "DL3009"]

  - repo: https://github.com/pryorda/dockerfilelint-precommit-hooks
    rev: 1880d3752044754d2b88f3aa32e44620e02092fe  # pragma: allowlist secret
    hooks:
      - id: dockerfilelint
        files: Dockerfile.*$

  # =============================================================================
  # YAML / JSON / GITOPS
  # =============================================================================
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.35.1
    hooks:
      - id: yamllint
        args: ["-c", ".yamllint.yaml"]
        exclude: ^(charts/|templates/|\.github/workflows/)

  - repo: https://github.com/python-jsonschema/check-jsonschema
    rev: 0.34.0
    hooks:
      - id: check-github-workflows
      - id: check-github-actions
      - id: check-dependabot
      - id: check-renovate
      - id: check-azure-pipelines
      - id: check-gitlab-ci
      - id: check-bitbucket-pipelines

  - repo: https://github.com/rhysd/actionlint
    rev: v1.7.8
    hooks:
      - id: actionlint
        stages: [pre-commit]

  # =============================================================================
  # COMMITS & DOCS
  # =============================================================================
  - repo: https://github.com/commitizen-tools/commitizen
    rev: v4.2.1
    hooks:
      - id: commitizen
        stages: [commit-msg]

      - id: commitizen-branch
        stages: [pre-push]

  - repo: https://github.com/jorisroovers/gitlint
    rev: v0.19.1
    hooks:
      - id: gitlint
        stages: [commit-msg]

  - repo: https://github.com/DavidAnson/markdownlint-cli2
    rev: d7a4f7cf4914d3bffb9b83bdbc45fd2a00c91ff9  # pragma: allowlist secret
    hooks:
      - id: markdownlint-cli2
        args: ["--config", ".markdownlint.yaml"]
        exclude: ^(CHANGELOG\.md|LICENSE\.md|docs/.*|\.cursor/.*|AGENTS\.md|README\.md|tests/.*/README\.md)$
